<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Schedule Kelas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            padding-top: 0;
            transition: padding-top 0.5s ease;
            background-image: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=2071&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .hidden { display: none; }
        .modal-backdrop {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            transform: scale(0.9); opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .modal-backdrop.flex { display: flex; }
        .modal-backdrop.flex .modal-content { transform: scale(1); opacity: 1; }
        .toast {
            position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
            transition: bottom 0.5s ease-in-out; z-index: 1100;
        }
        .toast.show { bottom: 20px; }
        #notification-banner {
            transition: transform 0.5s ease-in-out;
        }
        .tab-btn.active {
            border-color: #38bdf8; /* sky-400 */
            color: #38bdf8;
            background-color: rgba(14, 116, 144, 0.2); /* cyan-700/20 */
        }
        .glass-card {
            background-color: rgba(15, 23, 42, 0.7); /* bg-slate-900/70 */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .input-dark {
            background-color: rgba(15, 23, 42, 0.8); /* bg-slate-900/80 */
            border-color: #475569; /* slate-600 */
        }
        .input-dark:focus {
            border-color: #38bdf8; /* sky-400 */
            --tw-ring-color: #38bdf8;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200">

    <div id="notification-banner" class="hidden fixed top-0 left-0 right-0 bg-green-500 text-white p-4 text-center z-[2000] shadow-lg transform -translate-y-full">
        <span id="notification-message" class="font-semibold"></span>
        <button id="close-notification-btn" class="absolute top-1/2 right-4 -translate-y-1/2 font-bold text-2xl leading-none">&times;</button>
    </div>

    <div id="login-page" class="flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-sm p-8 space-y-6 rounded-2xl shadow-lg glass-card relative">
            <!-- Step 1: Class Selection -->
            <div id="class-selection-step">
                <div>
                    <h1 class="text-3xl font-bold text-center text-slate-100">E-Schedule</h1>
                    <p class="text-center text-slate-400 mt-2">Selamat datang, Kapten!</p>
                </div>
                <div class="space-y-4 pt-6">
                    <div>
                        <label for="class-select" class="text-sm font-medium text-slate-300">Pilih Kelas</label>
                        <select id="class-select" name="class-select" required class="w-full px-3 py-2 mt-1 rounded-lg focus:ring-2 transition input-dark">
                            <option value="" disabled selected>-- Pilih Kelas Anda --</option>
                        </select>
                    </div>
                    <p id="class-select-error" class="text-sm text-red-400 hidden">Silakan pilih kelas terlebih dahulu!</p>
                    <button id="continue-btn" type="button" class="w-full py-3 font-semibold text-white bg-sky-600 rounded-lg hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 focus:ring-offset-slate-900 transition">Lanjutkan</button>
                </div>
            </div>

            <!-- Step 2: Credentials -->
            <div id="credential-step" class="hidden">
                 <button id="back-btn" class="absolute top-4 left-4 text-slate-400 hover:text-slate-200 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                  </button>
                <div>
                    <h1 class="text-3xl font-bold text-center text-slate-100">Login</h1>
                    <p class="text-center text-slate-400 mt-2">Kelas: <span id="selected-class-display" class="font-bold text-sky-400"></span></p>
                </div>
                <form id="login-form" class="space-y-4 pt-6">
                    <div>
                        <label for="username" class="text-sm font-medium text-slate-300">Username</label>
                        <input id="username" name="username" type="text" required class="w-full px-3 py-2 mt-1 rounded-lg focus:ring-2 transition input-dark" placeholder="Username Anda">
                    </div>
                    <div>
                        <label for="password" class="text-sm font-medium text-slate-300">Password</label>
                        <input id="password" name="password" type="password" required class="w-full px-3 py-2 mt-1 rounded-lg focus:ring-2 transition input-dark" placeholder="••••••••">
                    </div>
                    <p id="login-error" class="text-sm text-red-400 hidden">Username atau password salah!</p>
                    <button type="submit" class="w-full py-3 font-semibold text-white bg-sky-600 rounded-lg hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 focus:ring-offset-slate-900 transition">Login</button>
                </form>
                <p class="text-xs text-center text-slate-400 pt-4">
                    Belum punya akun? <a href="#" class="font-medium text-sky-400 hover:underline">Daftar disini</a>
                </p>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div class="container mx-auto max-w-5xl p-4 sm:p-6">
            <header class="text-center mb-6">
                 <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <div id="welcome-message" class="text-left text-sm text-slate-400"></div>
                    <div id="clock" class="text-sm font-semibold text-slate-300 glass-card px-3 py-1 rounded-lg"></div>
                    <button id="logout-btn" class="text-sm font-medium bg-slate-700 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-600 transition">Logout</button>
                </div>
                <h1 class="text-4xl font-bold text-slate-100 tracking-wider">E-Schedule Kelas</h1>
                <p id="class-display" class="text-sky-400 font-semibold mt-2"></p>
            </header>

            <div class="mb-6 flex flex-wrap justify-center border-b border-slate-700">
                 <button id="tab-schedule" class="tab-btn active text-slate-300 py-3 px-6 font-semibold border-b-2 border-transparent transition hover:bg-slate-800/50">Jadwal Kelas</button>
                 <button id="tab-tasks" class="tab-btn text-slate-300 py-3 px-6 font-semibold border-b-2 border-transparent transition hover:bg-slate-800/50">Tugas Pelajaran</button>
                 <button id="tab-piket" class="tab-btn text-slate-300 py-3 px-6 font-semibold border-b-2 border-transparent transition hover:bg-slate-800/50">Jadwal Piket</button>
                 <button id="tab-users" class="tab-btn text-slate-300 py-3 px-6 font-semibold border-b-2 border-transparent transition hover:bg-slate-800/50 hidden">Kelola User</button>
            </div>

            <div id="admin-controls" class="flex justify-center gap-4 mb-8 hidden">
                <button id="add-schedule-btn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-transform transform hover:scale-105 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                    Tambah Jadwal
                </button>
                 <button id="add-task-btn" class="bg-amber-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-amber-600 transition-transform transform hover:scale-105 hidden items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z" clip-rule="evenodd" /></svg>
                    Tambah Tugas
                </button>
                <button id="edit-piket-btn" class="bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition-transform transform hover:scale-105 hidden items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zm-1.5 5.5a3 3 0 00-3 0V12a2 2 0 00-2 2v1a2 2 0 002 2h3.5a2 2 0 002-2v-1a2 2 0 00-2-2v-.5zM16 6a3 3 0 11-6 0 3 3 0 016 0zm-1.5 5.5a3 3 0 00-3 0V12a2 2 0 00-2 2v1a2 2 0 002 2H16a2 2 0 002-2v-1a2 2 0 00-2-2v-.5z" /></svg>
                    Ubah Piket
                </button>
                <button id="add-user-btn" class="bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-purple-700 transition-transform transform hover:scale-105 hidden items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                    Tambah User
                </button>
            </div>

            <main id="schedule-container" class="space-y-8"></main>
            <main id="tasks-container" class="hidden"></main>
            <main id="piket-container" class="hidden"></main>
            <main id="users-container" class="hidden"></main>
        </div>
    </div>

    <!-- Modals -->
    <div id="schedule-modal" class="modal-backdrop"> <div class="modal-content w-full max-w-md p-6 rounded-2xl shadow-2xl m-4 glass-card"> <h2 id="schedule-modal-title" class="text-2xl font-bold mb-6 text-slate-100"></h2> <form id="schedule-form"> <input type="hidden" id="schedule-id"> <div class="space-y-4 text-slate-300"> <div><label for="day" class="block text-sm font-medium mb-1">Hari</label><select id="day" required class="w-full px-3 py-2 rounded-lg focus:ring-2 transition input-dark"><option>Senin</option><option>Selasa</option><option>Rabu</option><option>Kamis</option><option>Jumat</option><option>Sabtu</option></select></div> <div><label for="subject" class="block text-sm font-medium mb-1">Mata Pelajaran</label><input type="text" id="subject" required class="w-full px-3 py-2 rounded-lg focus:ring-2 transition input-dark" placeholder="Contoh: Matematika"></div> <div class="grid grid-cols-2 gap-4"> <div><label for="start-time" class="block text-sm font-medium mb-1">Waktu Mulai</label><input type="time" id="start-time" required class="w-full px-3 py-2 rounded-lg focus:ring-2 transition input-dark"></div> <div><label for="end-time" class="block text-sm font-medium mb-1">Waktu Selesai</label><input type="time" id="end-time" required class="w-full px-3 py-2 rounded-lg focus:ring-2 transition input-dark"></div> </div> <div><label for="teacher" class="block text-sm font-medium mb-1">Guru</label><input type="text" id="teacher" class="w-full px-3 py-2 rounded-lg focus:ring-2 transition input-dark" placeholder="Contoh: Bpk. Andi"></div> <div><label for="room" class="block text-sm font-medium mb-1">Ruangan</label><input type="text" id="room" class="w-full px-3 py-2 rounded-lg focus:ring-2 transition input-dark" placeholder="Contoh: Lab Komputer"></div> </div> <div class="flex justify-end gap-3 mt-8"> <button type="button" id="cancel-schedule-btn" class="px-4 py-2 bg-slate-600 text-slate-200 rounded-lg hover:bg-slate-500">Batal</button> <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Simpan</button> </div> </form> </div> </div>
    <div id="task-modal" class="modal-backdrop"> <div class="modal-content w-full max-w-md p-6 rounded-2xl shadow-2xl m-4 glass-card"> <h2 id="task-modal-title" class="text-2xl font-bold mb-6 text-slate-100"></h2> <form id="task-form"> <input type="hidden" id="task-id"> <div class="space-y-4 text-slate-300"> <div><label for="task-subject" class="block text-sm font-medium mb-1">Mata Pelajaran</label><input type="text" id="task-subject" required class="w-full px-3 py-2 rounded-lg focus:ring-2 transition input-dark" placeholder="Contoh: Fisika"></div> <div><label for="task-title" class="block text-sm font-medium mb-1">Judul Tugas</label><input type="text" id="task-title" required class="w-full px-3 py-2 rounded-lg focus:ring-2 transition input-dark" placeholder="Contoh: Laporan Praktikum"></div> <div><label for="task-due-date" class="block text-sm font-medium mb-1">Tenggat Waktu</label><input type="date" id="task-due-date" required class="w-full px-3 py-2 rounded-lg focus:ring-2 transition input-dark"></div> <div><label for="task-description" class="block text-sm font-medium mb-1">Deskripsi</label><textarea id="task-description" rows="3" class="w-full px-3 py-2 rounded-lg focus:ring-2 transition input-dark" placeholder="Detail tugas..."></textarea></div> </div> <div class="flex justify-end gap-3 mt-8"> <button type="button" id="cancel-task-btn" class="px-4 py-2 bg-slate-600 rounded-lg hover:bg-slate-500">Batal</button> <button type="submit" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">Simpan</button> </div> </form> </div> </div>
    <div id="piket-modal" class="modal-backdrop"> <div class="modal-content w-full max-w-md p-6 rounded-2xl shadow-2xl m-4 glass-card"> <h2 id="piket-modal-title" class="text-2xl font-bold mb-6 text-slate-100">Ubah Jadwal Piket</h2> <form id="piket-form"> <input type="hidden" id="piket-day"> <div class="space-y-4 text-slate-300"> <div><label for="piket-day-display" class="block text-sm font-medium mb-1">Hari</label><input type="text" id="piket-day-display" readonly class="w-full px-3 py-2 bg-slate-700/50 border border-slate-600 rounded-lg"></div> <div><label for="piket-students" class="block text-sm font-medium mb-1">Nama Siswa (pisahkan dengan koma)</label><textarea id="piket-students" rows="5" required class="w-full px-3 py-2 rounded-lg focus:ring-2 transition input-dark" placeholder="Contoh: Budi, Ani, Candra, Dewi"></textarea></div> </div> <div class="flex justify-end gap-3 mt-8"> <button type="button" id="cancel-piket-btn" class="px-4 py-2 bg-slate-600 rounded-lg hover:bg-slate-500">Batal</button> <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Simpan</button> </div> </form> </div> </div>
    
    <div id="user-modal" class="modal-backdrop">
        <div class="modal-content w-full max-w-md p-6 rounded-2xl shadow-2xl m-4 glass-card">
            <h2 id="user-modal-title" class="text-2xl font-bold mb-6 text-slate-100"></h2>
            <form id="user-form">
                <input type="hidden" id="user-id">
                <div class="space-y-4 text-slate-300">
                    <div><label for="user-username" class="block text-sm font-medium mb-1">Username</label><input type="text" id="user-username" required class="w-full px-3 py-2 rounded-lg focus:ring-2 transition input-dark"></div>
                    <div><label for="user-password" class="block text-sm font-medium mb-1">Password</label><input type="password" id="user-password" required class="w-full px-3 py-2 rounded-lg focus:ring-2 transition input-dark"></div>
                    <div><label for="user-role" class="block text-sm font-medium mb-1">Peran</label><select id="user-role" required class="w-full px-3 py-2 rounded-lg focus:ring-2 transition input-dark"><option value="siswa">Siswa</option><option value="admin">Admin</option></select></div>
                </div>
                <div class="flex justify-end gap-3 mt-8">
                    <button type="button" id="cancel-user-btn" class="px-4 py-2 bg-slate-600 rounded-lg hover:bg-slate-500">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="toast bg-slate-100 text-slate-900 py-2 px-5 rounded-full shadow-lg">
        <p id="toast-message" class="font-semibold"></p>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    const classSelect = document.getElementById('class-select');
    const classDisplay = document.getElementById('class-display');
    const loginPage = document.getElementById('login-page');
    const classSelectionStep = document.getElementById('class-selection-step');
    const credentialStep = document.getElementById('credential-step');
    const continueBtn = document.getElementById('continue-btn');
    const backBtn = document.getElementById('back-btn');
    const selectedClassDisplay = document.getElementById('selected-class-display');
    const classSelectError = document.getElementById('class-select-error');
    const mainApp = document.getElementById('main-app');
    const loginForm = document.getElementById('login-form'), loginError = document.getElementById('login-error');
    const logoutBtn = document.getElementById('logout-btn'), welcomeMessage = document.getElementById('welcome-message');
    const adminControls = document.getElementById('admin-controls'), addScheduleBtn = document.getElementById('add-schedule-btn'), addTaskBtn = document.getElementById('add-task-btn'), editPiketBtn = document.getElementById('edit-piket-btn'), addUserBtn = document.getElementById('add-user-btn');
    const scheduleModal = document.getElementById('schedule-modal'), scheduleModalTitle = document.getElementById('schedule-modal-title'), scheduleForm = document.getElementById('schedule-form'), cancelScheduleBtn = document.getElementById('cancel-schedule-btn');
    const taskModal = document.getElementById('task-modal'), taskModalTitle = document.getElementById('task-modal-title'), taskForm = document.getElementById('task-form'), cancelTaskBtn = document.getElementById('cancel-task-btn');
    const piketModal = document.getElementById('piket-modal'), piketForm = document.getElementById('piket-form'), cancelPiketBtn = document.getElementById('cancel-piket-btn');
    const userModal = document.getElementById('user-modal'), userModalTitle = document.getElementById('user-modal-title'), userForm = document.getElementById('user-form'), cancelUserBtn = document.getElementById('cancel-user-btn');
    const tabSchedule = document.getElementById('tab-schedule'), tabTasks = document.getElementById('tab-tasks'), tabPiket = document.getElementById('tab-piket'), tabUsers = document.getElementById('tab-users');
    const scheduleContainer = document.getElementById('schedule-container'), tasksContainer = document.getElementById('tasks-container'), piketContainer = document.getElementById('piket-container'), usersContainer = document.getElementById('users-container');
    const toast = document.getElementById('toast'), toastMessage = document.getElementById('toast-message');
    const clockDisplay = document.getElementById('clock'), notificationBanner = document.getElementById('notification-banner'), notificationMessage = document.getElementById('notification-message'), closeNotificationBtn = document.getElementById('close-notification-btn');

    // --- Constants & State ---
    const USERS_STORAGE_KEY = 'appUsers', SCHEDULE_KEY_PREFIX = 'classSchedules', TASKS_KEY_PREFIX = 'classTasks', PIKET_KEY_PREFIX = 'classPiket', SESSION_KEY = 'loggedInUser';
    const daysOrder = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
    let currentUser = null, notifiedBreaks = JSON.parse(sessionStorage.getItem('notifiedBreaksToday')) || [], clockInterval, breakCheckInterval;

    // --- Helper Functions ---
    const getUsers = () => JSON.parse(localStorage.getItem(USERS_STORAGE_KEY)) || [];
    const saveUsers = (u) => localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(u));
    const getStorageKey = (prefix) => { if (!currentUser || !currentUser.selectedClass) return null; return `${prefix}_${currentUser.selectedClass}`; }
    const getSchedules = () => JSON.parse(localStorage.getItem(getStorageKey(SCHEDULE_KEY_PREFIX))) || [];
    const saveSchedules = (s) => localStorage.setItem(getStorageKey(SCHEDULE_KEY_PREFIX), JSON.stringify(s));
    const getTasks = () => JSON.parse(localStorage.getItem(getStorageKey(TASKS_KEY_PREFIX))) || [];
    const saveTasks = (t) => localStorage.setItem(getStorageKey(TASKS_KEY_PREFIX), JSON.stringify(t));
    const getPiket = () => JSON.parse(localStorage.getItem(getStorageKey(PIKET_KEY_PREFIX))) || [];
    const savePiket = (p) => localStorage.setItem(getStorageKey(PIKET_KEY_PREFIX), JSON.stringify(p));
    const getSession = () => JSON.parse(sessionStorage.getItem(SESSION_KEY));
    const setSession = (u) => sessionStorage.setItem(SESSION_KEY, JSON.stringify(u));
    const clearSession = () => sessionStorage.removeItem(SESSION_KEY);
    const showToast = (msg) => { toastMessage.textContent = msg; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 3000); };
    
    // --- Data Population ---
    const populateInitialUsers = () => {
        if (getUsers().length === 0) {
            saveUsers([
                { id: 'admin', password: 'admin123', role: 'admin' },
                { id: 'siswa', password: 'smanida', role: 'siswa' }
            ]);
        }
    };
    const populateInitialDataForClass = () => {
        if (!localStorage.getItem(getStorageKey(SCHEDULE_KEY_PREFIX))) {
            const initialSchedules = [ 
                { id: "101", type: "class", day: "Senin", subject: "Upacara Bendera", startTime: "07:00", endTime: "07:45", teacher: "Semua Guru", room: "Lapangan" },{ id: "102", type: "class", day: "Senin", subject: "Matematika", startTime: "07:45", endTime: "09:15", teacher: "Bpk. Budi Darmawan", room: "Ruang 101" },{ id: "b1s", type: "break", day: "Senin", subject: "Istirahat", startTime: "09:15", endTime: "09:45" },{ id: "103", type: "class", day: "Senin", subject: "Bahasa Indonesia", startTime: "09:45", endTime: "11:15", teacher: "Ibu Siti Aminah", room: "Ruang 101" },{ id: "b2s", type: "break", day: "Senin", subject: "Istirahat Siang", startTime: "11:15", endTime: "12:15" },{ id: "104", type: "class", day: "Senin", subject: "Fisika", startTime: "12:15", endTime: "13:45", teacher: "Bpk. Agung Prasetyo", room: "Lab Fisika" },
                { id: "201", type: "class", day: "Selasa", subject: "Bahasa Inggris", startTime: "07:00", endTime: "08:30", teacher: "Ibu Grace Kelly", room: "Ruang 102" },{ id: "202", type: "class", day: "Selasa", subject: "Kimia", startTime: "08:30", endTime: "10:00", teacher: "Ibu Retno Wulandari", room: "Lab Kimia" },{ id: "b1t", type: "break", day: "Selasa", subject: "Istirahat", startTime: "10:00", endTime: "10:30" },{ id: "203", type: "class", day: "Selasa", subject: "Sejarah Indonesia", startTime: "10:30", endTime: "12:00", teacher: "Bpk. Tirtayasa", room: "Ruang 102" },{ id: "b2t", type: "break", day: "Selasa", subject: "Istirahat Siang", startTime: "12:00", endTime: "13:00" },{ id: "204", type: "class", day: "Selasa", subject: "Seni Budaya", startTime: "13:00", endTime: "14:30", teacher: "Ibu Endah Laras", room: "Ruang Seni" },
                { id: "301", type: "class", day: "Rabu", subject: "Biologi", startTime: "07:00", endTime: "08:30", teacher: "Ibu Diah Pitaloka", room: "Lab Biologi" },{ id: "302", type: "class", day: "Rabu", subject: "Matematika", startTime: "08:30", endTime: "10:00", teacher: "Bpk. Budi Darmawan", room: "Ruang 101" },{ id: "b1w", type: "break", day: "Rabu", subject: "Istirahat", startTime: "10:00", endTime: "10:30" },{ id: "303", type: "class", day: "Rabu", subject: "Geografi", startTime: "10:30", endTime: "12:00", teacher: "Bpk. Rahmat", room: "Ruang 103" },{ id: "b2w", type: "break", day: "Rabu", subject: "Istirahat Siang", startTime: "12:00", endTime: "13:00" },{ id: "304", type: "class", day: "Rabu", subject: "PJOK", startTime: "13:00", endTime: "14:30", teacher: "Bpk. Doni", room: "Lapangan" },
                { id: "401", type: "class", day: "Kamis", subject: "Bahasa Indonesia", startTime: "07:00", endTime: "08:30", teacher: "Ibu Siti Aminah", room: "Ruang 101" },{ id: "402", type: "class", day: "Kamis", subject: "Fisika", startTime: "08:30", endTime: "10:00", teacher: "Bpk. Agung Prasetyo", room: "Lab Fisika" },{ id: "b1th", type: "break", day: "Kamis", subject: "Istirahat", startTime: "10:00", endTime: "10:30" },{ id: "403", type: "class", day: "Kamis", subject: "Ekonomi", startTime: "10:30", endTime: "12:00", teacher: "Ibu Sri Mulyani", room: "Ruang 103" },{ id: "b2th", type: "break", day: "Kamis", subject: "Istirahat Siang", startTime: "12:00", endTime: "13:00" },{ id: "404", type: "class", day: "Kamis", subject: "PPKn", startTime: "13:00", endTime: "14:30", teacher: "Bpk. Gatot S.", room: "Ruang 101" },
                { id: "501", type: "class", day: "Jumat", subject: "Kegiatan Rohani", startTime: "07:00", endTime: "08:00", teacher: "Guru Agama", room: "Aula" },{ id: "502", type: "class", day: "Jumat", subject: "Bahasa Inggris", startTime: "08:00", endTime: "09:30", teacher: "Ibu Grace Kelly", room: "Ruang 102" },{ id: "b1f", type: "break", day: "Jumat", subject: "Istirahat", startTime: "09:30", endTime: "10:00" },{ id: "503", type: "class", day: "Jumat", subject: "Sosiologi", startTime: "10:00", endTime: "11:30", teacher: "Bpk. Joko Susilo", room: "Ruang 103" },{ id: "b2f", type: "break", day: "Jumat", subject: "Sholat Jumat", startTime: "11:30", endTime: "13:00" },{ id: "504", type: "class", day: "Jumat", subject: "TIK", startTime: "13:00", endTime: "14:30", teacher: "Bpk. Hendi", room: "Lab Komputer" },
            ];
            saveSchedules(initialSchedules);
        }
        if (!localStorage.getItem(getStorageKey(TASKS_KEY_PREFIX))) {
            const initialTasks = [
                { id: "t1", subject: "Fisika", title: "Laporan Praktikum Gerak Lurus", dueDate: "2025-10-10", description: "Tulis laporan lengkap berdasarkan praktikum yang dilakukan di lab minggu lalu." },
                { id: "t2", subject: "B. Indonesia", title: "Analisis Puisi Chairil Anwar", dueDate: "2025-10-13", description: "Pilih salah satu puisi karya Chairil Anwar, analisis unsur intrinsik dan ekstrinsiknya." },
                { id: "t3", subject: "Sejarah", title: "Makalah Perang Dunia II", dueDate: "2025-10-20", description: "Buat makalah minimal 5 halaman mengenai dampak Perang Dunia II bagi Indonesia." },
                { id: "t4", subject: "Kimia", title: "Latihan Soal Stoikiometri", dueDate: "2025-10-08", description: "Kerjakan soal-soal di LKS halaman 30-32." },
            ];
            saveTasks(initialTasks);
        }
        if (!localStorage.getItem(getStorageKey(PIKET_KEY_PREFIX))) {
            savePiket([
                { day: "Senin", students: ["Andi", "Bunga", "Citra", "Doni", "Egi"] },
                { day: "Selasa", students: ["Fani", "Gita", "Hadi", "Indra", "Joko"] },
                { day: "Rabu", students: ["Karin", "Lina", "Mira", "Nino", "Olga"] },
                { day: "Kamis", students: ["Putra", "Rani", "Sari", "Tono", "Vina"] },
                { day: "Jumat", students: ["Wulan", "Yudi", "Zahra", "Adi", "Bela"] },
                { day: "Sabtu", students: ["Candra", "Dewi", "Fajar", "Gilang", "Hana"] },
            ]);
        }
    }

    // --- Clock, Notification, Render functions ---
    const updateClock = () => { const n=new Date(); clockDisplay.innerHTML = `${n.toLocaleDateString('id-ID',{weekday:'long',day:'numeric',month:'long'})} | <strong>${n.toLocaleTimeString('id-ID')}</strong>`; };
    const showNotification = (msg) => { notificationMessage.textContent=msg; notificationBanner.classList.remove('hidden'); setTimeout(() => { notificationBanner.classList.remove('-translate-y-full'); document.body.style.paddingTop = `${notificationBanner.offsetHeight}px`; }, 10); };
    const hideNotification = () => { notificationBanner.classList.add('-translate-y-full'); document.body.style.paddingTop = '0'; };
    const checkBreaks = () => { const n=new Date(), d=['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'][n.getDay()], t=n.toTimeString().slice(0,5); const b = getSchedules().find(s=>s.day===d && s.startTime===t && s.type==='break' && !notifiedBreaks.includes(s.id)); if (b) { showNotification(`🔔 Waktunya ${b.subject}! (${b.startTime} - ${b.endTime})`); notifiedBreaks.push(b.id); sessionStorage.setItem('notifiedBreaksToday',JSON.stringify(notifiedBreaks)); } };
    const createScheduleCard = (schedule, role) => {
        const cardClasses = "p-5 rounded-xl glass-card transition-all duration-300 hover:border-sky-400";
        if (schedule.type === 'break') {
            return `<div class="${cardClasses} text-emerald-300 flex items-center justify-center text-center"><h3 class="text-xl font-bold">${schedule.subject}</h3><p class="font-semibold text-lg ml-2">${schedule.startTime} - ${schedule.endTime}</p></div>`;
        }
        const adminButtons = role === 'admin' ? `<div class="flex justify-end gap-3 mt-4"><button data-id="${schedule.id}" class="edit-schedule-btn text-sky-400 hover:text-sky-300 text-sm font-medium">Ubah</button><button data-id="${schedule.id}" class="delete-schedule-btn text-red-400 hover:text-red-300 text-sm font-medium">Hapus</button></div>` : '';
        return `<div class="${cardClasses}"><h3 class="text-xl font-bold text-slate-100">${schedule.subject}</h3><p class="text-sky-400 font-semibold">${schedule.startTime} - ${schedule.endTime}</p><p class="text-slate-400 mt-1">${schedule.teacher}</p>${adminButtons}</div>`;
    };
    const renderSchedules = () => {
        scheduleContainer.innerHTML = '';
        const schedules = getSchedules();
        const schedulesByDay = daysOrder.reduce((acc, day) => {
            const filtered = schedules.filter(s => s.day === day).sort((a, b) => a.startTime.localeCompare(b.startTime));
            if (filtered.length > 0) acc[day] = filtered;
            return acc;
        }, {});
        if (Object.keys(schedulesByDay).length === 0) {
             scheduleContainer.innerHTML = `<div class="text-center p-10 rounded-xl glass-card"><p class="text-slate-400">Jadwal untuk kelas ini belum diatur.</p></div>`;
             return;
        }
        for (const day of daysOrder) {
            if (schedulesByDay[day]) {
                const daySection = document.createElement('section');
                daySection.innerHTML = `<h2 class="text-2xl font-bold mb-4 text-slate-100">${day}</h2><div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">${schedulesByDay[day].map(s => createScheduleCard(s, currentUser.role)).join('')}</div>`;
                scheduleContainer.appendChild(daySection);
            }
        }
    };
    const createTaskCard = (task, role) => {
        const adminButtons = role === 'admin' ? `<div class="flex justify-end gap-3 mt-4 pt-3 border-t border-slate-700"><button data-id="${task.id}" class="edit-task-btn text-sky-400 hover:text-sky-300 text-sm font-medium">Ubah</button><button data-id="${task.id}" class="delete-task-btn text-red-400 hover:text-red-300 text-sm font-medium">Hapus</button></div>` : '';
        return `<div class="p-5 rounded-xl glass-card flex flex-col justify-between transition-all duration-300 hover:border-amber-400"><span class="bg-amber-400/20 text-amber-300 text-xs font-semibold px-2 py-1 rounded-full self-start">${task.subject}</span><h3 class="text-xl font-bold mt-2 text-slate-100">${task.title}</h3><p class="text-slate-400 mt-1 text-sm">${task.description || ''}</p><div><p class="text-sm font-semibold text-red-400 mt-4 pt-3 border-t border-slate-700">Tenggat: ${new Date(task.dueDate+'T00:00:00').toLocaleDateString('id-ID',{weekday:'long',day:'numeric',month:'long'})}</p>${adminButtons}</div></div>`;
    };
    const renderTasks = () => {
        tasksContainer.innerHTML = '';
        const tasks = getTasks().sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
        if (tasks.length === 0) {
            tasksContainer.innerHTML = `<div class="text-center p-10 rounded-xl glass-card"><p class="text-slate-400">Tidak ada tugas saat ini.</p></div>`;
            return;
        }
        tasksContainer.innerHTML = `<div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">${tasks.map(t => createTaskCard(t, currentUser.role)).join('')}</div>`;
    };
    const createPiketCard = (piketData, role) => {
        const studentList = piketData.students.map(name => `<li class="bg-green-500/20 text-green-300 rounded-md px-3 py-1 text-sm">${name}</li>`).join('');
        const adminButton = role === 'admin' ? `<button data-day="${piketData.day}" class="edit-piket-card-btn absolute top-4 right-4 text-sm font-medium text-sky-400 hover:text-sky-300">Ubah</button>` : '';
        return `<div class="p-5 rounded-xl glass-card relative transition-all duration-300 hover:border-green-400"><h3 class="text-xl font-bold mb-4 text-slate-100">${piketData.day}</h3><ul class="flex flex-wrap gap-2">${studentList}</ul>${adminButton}</div>`;
    };
    const renderPiket = () => {
        piketContainer.innerHTML = '';
        const piketData = getPiket();
        piketContainer.innerHTML = `<div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">${piketData.map(p => createPiketCard(p, currentUser.role)).join('')}</div>`;
    };
    
    const createUserCard = (user) => {
        const roleBadge = user.role === 'admin' 
            ? `<span class="bg-red-500/20 text-red-300 text-xs font-semibold px-2 py-1 rounded-full">Admin</span>`
            : `<span class="bg-sky-500/20 text-sky-300 text-xs font-semibold px-2 py-1 rounded-full">Siswa</span>`;
        
        const deleteBtnDisabled = user.id === currentUser.id ? 'disabled opacity-50 cursor-not-allowed' : '';
        
        return `
            <div class="p-5 rounded-xl glass-card flex items-center justify-between">
                <div>
                    <h3 class="text-xl font-bold text-slate-100">${user.id}</h3>
                    ${roleBadge}
                </div>
                <div class="flex gap-3">
                    <button data-id="${user.id}" class="edit-user-btn text-sky-400 hover:text-sky-300 text-sm font-medium">Ubah</button>
                    <button data-id="${user.id}" class="delete-user-btn text-red-400 hover:text-red-300 text-sm font-medium" ${deleteBtnDisabled}>Hapus</button>
                </div>
            </div>
        `;
    };
    const renderUsers = () => {
        usersContainer.innerHTML = '';
        const users = getUsers();
        const grid = document.createElement('div');
        grid.className = 'grid gap-4 md:grid-cols-2';
        grid.innerHTML = users.map(createUserCard).join('');
        usersContainer.appendChild(grid);
    };

    // --- Modal Logic ---
    const showScheduleModal = (s = null) => { scheduleForm.reset(); scheduleModalTitle.textContent = s ? 'Ubah Jadwal' : 'Tambah Jadwal'; document.getElementById('schedule-id').value = s ? s.id : ''; if (s) { document.getElementById('day').value = s.day; document.getElementById('subject').value = s.subject; document.getElementById('start-time').value = s.startTime; document.getElementById('end-time').value = s.endTime; document.getElementById('teacher').value = s.teacher; document.getElementById('room').value = s.room; } scheduleModal.classList.add('flex'); };
    const hideScheduleModal = () => scheduleModal.classList.remove('flex');
    const showTaskModal = (t = null) => { taskForm.reset(); taskModalTitle.textContent = t ? 'Ubah Tugas' : 'Tambah Tugas'; document.getElementById('task-id').value = t ? t.id : ''; if (t) { document.getElementById('task-subject').value = t.subject; document.getElementById('task-title').value = t.title; document.getElementById('task-due-date').value = t.dueDate; document.getElementById('task-description').value = t.description; } taskModal.classList.add('flex'); };
    const hideTaskModal = () => taskModal.classList.remove('flex');
    const showPiketModal = (p) => { piketForm.reset(); document.getElementById('piket-day').value = p.day; document.getElementById('piket-day-display').value = p.day; document.getElementById('piket-students').value = p.students.join(', '); piketModal.classList.add('flex'); };
    const hidePiketModal = () => piketModal.classList.remove('flex');
    const showUserModal = (user = null) => {
        userForm.reset();
        userModalTitle.textContent = user ? 'Ubah Pengguna' : 'Tambah Pengguna Baru';
        document.getElementById('user-id').value = user ? user.id : '';
        const usernameField = document.getElementById('user-username');
        if (user) {
            usernameField.value = user.id;
            usernameField.readOnly = true;
            usernameField.classList.add('bg-slate-700/50');
            document.getElementById('user-password').value = user.password;
            document.getElementById('user-role').value = user.role;
        } else {
            usernameField.readOnly = false;
            usernameField.classList.remove('bg-slate-700/50');
        }
        userModal.classList.add('flex');
    };
    const hideUserModal = () => userModal.classList.remove('flex');

    // --- Application Flow ---
    const showLoginPage = () => {
        loginPage.classList.remove('hidden');
        mainApp.classList.add('hidden');
        credentialStep.classList.add('hidden');
        classSelectionStep.classList.remove('hidden');
    };
    const showMainApp = () => {
        loginPage.classList.add('hidden');
        mainApp.classList.remove('hidden');
        populateInitialDataForClass();
        welcomeMessage.textContent = `Selamat datang, ${currentUser.username}!`;
        classDisplay.textContent = `Menampilkan Jadwal untuk Kelas ${currentUser.selectedClass}`;
        adminControls.classList.toggle('hidden', currentUser.role !== 'admin');
        tabUsers.classList.toggle('hidden', currentUser.role !== 'admin');
        renderSchedules();
        renderTasks();
        renderPiket();
        if (currentUser.role === 'admin') renderUsers();
        tabSchedule.click();
        clockInterval = setInterval(updateClock, 1000);
        breakCheckInterval = setInterval(checkBreaks, 30000);
        updateClock();
        checkBreaks();
    };
    const handleLogout = () => { currentUser = null; clearSession(); showLoginPage(); clearInterval(clockInterval); clearInterval(breakCheckInterval); };

    // --- Event Handlers ---
    continueBtn.addEventListener('click', () => {
        const selectedClass = classSelect.value;
        if (selectedClass) {
            classSelectError.classList.add('hidden');
            selectedClassDisplay.textContent = selectedClass;
            classSelectionStep.classList.add('hidden');
            credentialStep.classList.remove('hidden');
        } else {
            classSelectError.classList.remove('hidden');
        }
    });

    backBtn.addEventListener('click', () => {
        credentialStep.classList.add('hidden');
        classSelectionStep.classList.remove('hidden');
    });

    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        loginError.classList.add('hidden');
        const selectedClass = classSelect.value;
        const username = e.target.username.value;
        const password = e.target.password.value;
        const users = getUsers();
        const user = users.find(u => u.id === username);

        if (user && user.password === password) {
            currentUser = { username, role: user.role, selectedClass };
            setSession(currentUser);
            showMainApp();
        } else {
            loginError.classList.remove('hidden');
        }
    });
    logoutBtn.addEventListener('click', handleLogout);
    
    const switchTab = (activeTab) => {
        [tabSchedule, tabTasks, tabPiket, tabUsers].forEach(t => t.classList.remove('active'));
        [scheduleContainer, tasksContainer, piketContainer, usersContainer].forEach(c => c.classList.add('hidden'));
        [addScheduleBtn, addTaskBtn, editPiketBtn, addUserBtn].forEach(b => b.classList.add('hidden'));
        activeTab.classList.add('active');
        if (activeTab === tabSchedule) { scheduleContainer.classList.remove('hidden'); addScheduleBtn.classList.remove('hidden'); }
        if (activeTab === tabTasks) { tasksContainer.classList.remove('hidden'); addTaskBtn.classList.remove('hidden'); }
        if (activeTab === tabPiket) { piketContainer.classList.remove('hidden'); editPiketBtn.classList.remove('hidden'); }
        if (activeTab === tabUsers) { usersContainer.classList.remove('hidden'); addUserBtn.classList.remove('hidden'); }
    };
    tabSchedule.addEventListener('click', () => switchTab(tabSchedule));
    tabTasks.addEventListener('click', () => switchTab(tabTasks));
    tabPiket.addEventListener('click', () => switchTab(tabPiket));
    tabUsers.addEventListener('click', () => switchTab(tabUsers));
    
    addScheduleBtn.addEventListener('click', () => showScheduleModal());
    addTaskBtn.addEventListener('click', () => showTaskModal());
    editPiketBtn.addEventListener('click', () => { const day = daysOrder[new Date().getDay()-1] || 'Senin'; const p = getPiket().find(pik=>pik.day===day) || getPiket()[0]; if(p) showPiketModal(p); });
    
    cancelScheduleBtn.addEventListener('click', hideScheduleModal);
    cancelTaskBtn.addEventListener('click', hideTaskModal);
    cancelPiketBtn.addEventListener('click', hidePiketModal);
    scheduleModal.addEventListener('click', (e) => e.target === scheduleModal && hideScheduleModal());
    taskModal.addEventListener('click', (e) => e.target === taskModal && hideTaskModal());
    piketModal.addEventListener('click', (e) => e.target === piketModal && hidePiketModal());
    closeNotificationBtn.addEventListener('click', hideNotification);
    
    scheduleForm.addEventListener('submit', (e) => { e.preventDefault(); const id = document.getElementById('schedule-id').value; const data = { id: id || '' + Date.now(), type: "class", day: document.getElementById('day').value, subject: document.getElementById('subject').value, startTime: document.getElementById('start-time').value, endTime: document.getElementById('end-time').value, teacher: document.getElementById('teacher').value, room: document.getElementById('room').value }; let s = getSchedules(); if (id) { const i = s.findIndex(x => x.id === id); if (i !== -1) s[i] = data; showToast('Jadwal diperbarui!'); } else { s.push(data); showToast('Jadwal ditambahkan!'); } saveSchedules(s); renderSchedules(); hideScheduleModal(); });
    taskForm.addEventListener('submit', (e) => { e.preventDefault(); const id = document.getElementById('task-id').value; const data = { id: id || '' + Date.now(), subject: document.getElementById('task-subject').value, title: document.getElementById('task-title').value, dueDate: document.getElementById('task-due-date').value, description: document.getElementById('task-description').value }; let t = getTasks(); if (id) { const i = t.findIndex(x => x.id === id); if (i !== -1) t[i] = data; showToast('Tugas diperbarui!'); } else { t.push(data); showToast('Tugas ditambahkan!'); } saveTasks(t); renderTasks(); hideTaskModal(); });
    piketForm.addEventListener('submit', (e) => { e.preventDefault(); const day = document.getElementById('piket-day').value; const students = document.getElementById('piket-students').value.split(',').map(n => n.trim()).filter(Boolean); let p = getPiket(); const i = p.findIndex(x => x.day === day); if (i !== -1) p[i].students = students; savePiket(p); renderPiket(); hidePiketModal(); showToast('Jadwal piket diperbarui!'); });
    
    scheduleContainer.addEventListener('click', (e) => { const btn = e.target.closest('button'); if (!btn) return; const id = btn.dataset.id; if (btn.classList.contains('delete-schedule-btn')) { saveSchedules(getSchedules().filter(s => s.id !== id)); renderSchedules(); showToast('Jadwal dihapus.'); } if (btn.classList.contains('edit-schedule-btn')) { const s = getSchedules().find(s => s.id === id); if (s) showScheduleModal(s); } });
    tasksContainer.addEventListener('click', (e) => { const btn = e.target.closest('button'); if (!btn) return; const id = btn.dataset.id; if (btn.classList.contains('delete-task-btn')) { saveTasks(getTasks().filter(t => t.id !== id)); renderTasks(); showToast('Tugas dihapus.'); } if (btn.classList.contains('edit-task-btn')) { const t = getTasks().find(t => t.id === id); if (t) showTaskModal(t); } });
    piketContainer.addEventListener('click', (e) => { const btn = e.target.closest('.edit-piket-card-btn'); if (btn) { const day = btn.dataset.day; const p = getPiket().find(x => x.day === day); if (p) showPiketModal(p); } });

    addUserBtn.addEventListener('click', () => showUserModal());
    cancelUserBtn.addEventListener('click', hideUserModal);
    userModal.addEventListener('click', (e) => e.target === userModal && hideUserModal());

    userForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('user-username').value;
        const originalId = document.getElementById('user-id').value;
        const data = {
            id,
            password: document.getElementById('user-password').value,
            role: document.getElementById('user-role').value
        };
        let users = getUsers();
        if (originalId) { // Editing
            const index = users.findIndex(u => u.id === originalId);
            if (index !== -1) users[index] = data;
            showToast('Pengguna berhasil diperbarui!');
        } else { // Adding
            if (users.some(u => u.id === id)) {
                showToast('Username sudah ada!');
                return;
            }
            users.push(data);
            showToast('Pengguna baru ditambahkan!');
        }
        saveUsers(users);
        renderUsers();
        hideUserModal();
    });
    
    usersContainer.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.dataset.id;
        if (btn.classList.contains('delete-user-btn')) {
            if (confirm(`Yakin ingin menghapus pengguna "${id}"?`)) {
                saveUsers(getUsers().filter(u => u.id !== id));
                renderUsers();
                showToast('Pengguna dihapus.');
            }
        }
        if (btn.classList.contains('edit-user-btn')) {
            const user = getUsers().find(u => u.id === id);
            if (user) showUserModal(user);
        }
    });

    // --- Initial Check ---
    const init = () => {
        populateInitialUsers();
        const classes = "ABCDEFGHIJKL".split('').map(char => `XII-${char}`);
        classes.forEach(c => {
            const option = document.createElement('option');
            option.value = c;
            option.textContent = c;
            classSelect.appendChild(option);
        });

        currentUser = getSession();
        if (currentUser) {
            showMainApp();
        } else {
            showLoginPage();
        }
    };
    init();
});
</script>
</body>
</html>
